{% extends "base.html" %}

{% block extrahead %}
  {{ block.super }}
  <link rel="stylesheet" href="{{ STATIC_URL }}base/bootstrap/css/bootstrap-responsive.min.css" type="text/css" media="screen"/>
  <script type="text/javascript" src="https://www.google.com/jsapi"></script>
  <script lang="javascript">
  var addedTasks = new Array();
  function initialiseTasks() {
    $('#tasks').load('{% url torrent_torrent_list %}');
  }
  function refreshTasks() {
    $.getJSON('{% url torrent_torrent_list format='json' %}', function(data) {
      $('.task').attr('data-stale', '');
      for (var i = 0; i < data.length; i++) {
        var task = data[i];
        var el = $(".task[data-id='" + task.id + "']");
        if (el.length == 0 && addedTasks.indexOf(task.id) == -1) {
          var $td = $('<td>');
          $('#tasks table').prepend($('<tr>').append($td));
          $td.load('./' + task.id);
          addedTasks.push(task.id);
          continue;
        }
        el.removeAttr('data-stale');
        for (key in task) {
          var value = task[key];
          if (key == 'progress') {
            el.find('.' + key).attr('class', 'progress ' + task.progress_css_class);
            el.find('.' + key + ' .bar').css({ width: value + '%' }).html(value + '%');
          } else {
            el.find('.' + key).html(value);
          }
          if (key == 'status') {
            if (value == 'stopped') {
              el.find('.action').attr('href', 'action/' + task.id + '/start');
              el.find('.action .mini-icon').removeClass('mini-icon-block').addClass('mini-icon-arr-collapsed');
            } else {
              el.find('.action').attr('href', 'action/' + task.id + '/stop');
              el.find('.action .mini-icon').removeClass('mini-icon-arr-collapsed').addClass('mini-icon-block');
            }
          }
        }
      }
      $('.task[data-stale]').parent().parent().remove();
    });
  }
  function searchTorrent(query, $element) {
    $element.attr('data-query', query);
    query = query.replace(/ /g, '+');
    var feed = new google.feeds.Feed("http://torrentz.com/feedP?q=" + query);
    feed.setNumEntries(100);
    feed.load(function(result) {
      if (!result.error) {
        var query = result.feed.description.replace(/ search$/, '');
        var $element = $("*[data-query='" + query + "']")
        $element.empty();
        for (var i = 0; i < result.feed.entries.length; i++) {
          var entry = result.feed.entries[i];
          var match = entry.link.match(/([0-9a-fA-F]{40})/);
          var hash = match[1];
          $element.append(
            $('<a>')
              .addClass('entry')
              .attr({
                'href': '#' + hash,
                'data-hash': hash,
                'data-text': entry.title,
                'data-query': query,
                'data-categories': entry.categories[0]
              })
              .html(entry.title)
              .append($('<span>').addClass('pull-right muted').text(entry.content))
              .click(function(event) {
                jQuery.get(
                  '{% url torrent_torrent_action action='add' %}/'+ $(this).attr('data-hash'),
                  {
                    'text': $(this).attr('data-text'),
                    'query': $(this).attr('data-query'),
                    'categories': $(this).attr('data-categories')
                  },
                  function(data) { $('#status').html(data); }
                );
                event.preventDefault();
                return false;
              })
          );
        }
      }
    });
  }
  function initialise() {}
  if (typeof google != 'undefined') {
    google.load("feeds", "1");
    google.setOnLoadCallback(initialise);
  }
  $(document).ready(function() {
    initialiseTasks();
    var refreshTasksThread = setInterval(refreshTasks, 1000);
    $('#search-form').submit(function(event) {
      searchTorrent($("input[name='q']", this).val(), $('.search-result', this));
      event.preventDefault();
      return false;
    });
  });
  </script>
  <style>
  body { margin: 0px!important; padding: 0px!important; }
  .navbar-fixed-bottom, .navbar-fixed-top { margin-top: 0px!important; margin-bottom: 0px!important; position: fixed!important; }
  .tab-content { margin-top: 60px; margin-bottom: 40px; }
  .task .status { text-transform: capitalize; }
  .task .progress { margin-bottom: 2px; }
  .task .btn { margin-left: 1px; padding: 0px 4px; }
  .task .btn .icon { margin-top: -2px; }
  .task .muted, .task .btn-mini, .task .progress .bar { font-size: 10.25px; }
  .search-result .entry { display: block; }
  #form-iframe { display: none; }
  #status { font-size: 12px; }
  </style>
{% endblock %}

{% block body %}
  <div class="navbar navbar-fixed-top navbar-inverse">
    <div class="navbar-inner">
      <ul id="tabs" class="nav">
        <li class="active"><a href="#tasks" data-toggle="tab">Tasks</a></li>
        <li><a href="#search" data-toggle="tab">Search</a></li>
      </ul>
    </div>
  </div>
  <div class="tab-content">
    <div class="tab-pane active" id="tasks"></div>
    <div class="tab-pane" id="search">
      <form id="search-form">
        <input type="text" placeholder="Search" name="q"/>
        <div class="search-result"></div>
      </form>
    </div>
  </div>
  <div class="navbar navbar-fixed-bottom navbar-inverse">
    <div class="navbar-inner">
      <a href="javascript:;" id="status" class="brand"></a>
    </div>
  </div>
  <iframe id="form-iframe" name="form-iframe"></iframe>
{% endblock %}
